@{
    var pageTitle = "See the questions!";
    var lecturename = "";

    var db = Database.Open("102547-concepttest");
    
    //var grid = new WebGrid(source: selectedData, defaultSort: "course_id", rowsPerPage: 3);
}

<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" type="text/css" href="StyleSheet.css">
        <title>@pageTitle</title>
        <link href="~/favicon.ico" rel="shortcut icon" type="image/x-icon" />
    </head>
    <body>
        <div>
            
            @{
                if(Request.QueryString["course"] != null) {
                    var selectedData = db.QuerySingle("SELECT id, course_id, course_name FROM T_Course WHERE course_id = @0", Request.QueryString["course"]);
                    var selectedLecture = db.Query("SELECT id, date FROM T_Lecture WHERE course_id = @0", selectedData.id);
                    var grid = new WebGrid(source: selectedLecture, defaultSort: "id", rowsPerPage: 3);
                    <h2>@selectedData.course_id @selectedData.course_name</h2>
                    <p>Lectures:</p>
                    if(selectedLecture.Count < 1) {
                        <p><i>No lectures for selected course...</i></p>
                    }
                    else {
                        foreach(var lecture in selectedLecture) {
                            <p><a href="?lecture=@lecture.id">@lecture.date</a></p>
                        }
                    }
                    <hr>
                    <p><a href="~/">Back to front page</a></p>
                }
                else if(Request.QueryString["lecture"] != null) {
                    var passwordMessage = "";
                    if(IsPost) {
                        var selectedLecture = db.QuerySingle("SELECT password FROM T_Lecture WHERE id = @0", Request.QueryString["lecture"]);
                        if(Request.Form["password"] == selectedLecture.password) {
                            HttpCookie studentCookie = new HttpCookie("studentCookie");
                            studentCookie.Value = Request.QueryString["lecture"];
                            studentCookie.Expires = DateTime.Now.AddMinutes(5);
                            Response.Cookies.Add(studentCookie);
                            passwordMessage = "";
                            var address = "?lecture=" + Request.QueryString["lecture"];
                            Response.Redirect(address);
                        }
                        else {
                            passwordMessage = "Wrong password!";
                        }
                    }
                    if(Request.Cookies["studentCookie"] != null)
                    {
                        HttpCookie aCookie = Request.Cookies["studentCookie"];
                        lecturename = aCookie.Value.ToString();
                    }

                    if (HttpContext.Current.Request.Cookies["studentCookie"] == null || lecturename != Request.QueryString["lecture"]) {
                        <form method="post">
                        <p>Password: <input type="password" name="password" autofocus="true"> <input type="submit" value="Submit"> </p><p class="red">@passwordMessage</p>
                        </form>
                    }
                    
                    if(lecturename == Request.QueryString["lecture"]) {
                        var selectQuestionId = db.Query("SELECT question_id FROM T_Question_Lecture WHERE lecture_id = @0", Request.QueryString["lecture"]);
                        var selectQuestionCount = db.QueryValue("SELECT COUNT(*) FROM T_Question_Lecture WHERE lecture_id = @0", Request.QueryString["lecture"]);
                        var selectedQuestion = db.Query("SELECT T_Question.question, T_Question.id FROM T_Question INNER JOIN T_Question_Lecture ON T_Question.id = T_Question_Lecture.question_id WHERE T_Question_Lecture.lecture_id = @0", Request.QueryString["lecture"]);
                        var hasAnsweredAllQuestions = "";
                        <form method="post">

                        @{
                        
                            if(IsPost) {
                                hasAnsweredAllQuestions = "1";
                                foreach(var question in selectedQuestion) {
                                    if(Request.Form["question-" + question.id] == null) {
                                        hasAnsweredAllQuestions = "0";
                                    }
                                }
                            }
                        

                        if(hasAnsweredAllQuestions == "0") {
                            <h2>SVARA PÅ ALLA FRÅGOR!</h2>
                        }
                        else if(hasAnsweredAllQuestions == "1") {
                            HttpCookie studentCookie = new HttpCookie("studentCookie-" + Request.QueryString["lecture"]);
                            studentCookie.Value = Request.QueryString["lecture"];
                            studentCookie.Expires = DateTime.Now.AddMinutes(1);
                            Response.Cookies.Add(studentCookie);
                        }
                        }
                        @foreach(var question in selectedQuestion) {
                            <div>
                            @{var selectedAnswers = db.Query("SELECT * FROM T_Answer WHERE question_id = @0", question.id);
                            var selectedAnswersRight = db.QueryValue("SELECT COUNT(*) FROM T_Answer WHERE question_id = @0 AND correct = 1", question.id);
                            <p><b>@question.question</b></p>
                            
                            if(selectedAnswersRight == 1) {
                                foreach(var answer in selectedAnswers) {
                                    <p><input type="radio" name="question-@question.id" value="@answer.id"> @answer.answer</p>
                                }
                                
                                if(IsPost && hasAnsweredAllQuestions == "1") {
                                    try {
                                        var answer = Request.Form["question-" + question.id];
                                        <p>For question @question.id you answered: @answer</p>
                                        var insertCommand = "INSERT INTO T_Statistics (question_id, answer_id, lecture_id) VALUES(@0, @1, @2)";
                                        db.Execute(insertCommand, @question.id, answer, Request.QueryString["lecture"]);
                                    }
                                    catch (Exception e) {
                                        <p>Exception occured: @e</p>
                                    }
                                    
                                }
                            }
                            else {
                                foreach(var answer in selectedAnswers) {
                                    <p><input type="checkbox" name="question-@question.id" value="@answer.id"> @answer.answer</p>
                                }
                                if(IsPost && hasAnsweredAllQuestions == "1") {
                                    var answer = Request.Form["question-" + question.id];
                                    if(answer != null) {
                                        string[] answers = answer.Split(',');
                                        <p>For question @question.id you answered: @answer</p>
                                        foreach(string word in answers) {
                                            try {
                                                //<p>@word</p>
                                                var insertCommand = "INSERT INTO T_Statistics (question_id, answer_id, lecture_id) VALUES(@0, @1, @2)";
                                                db.Execute(insertCommand, @question.id, word, Request.QueryString["lecture"]);
                                            }
                                            catch (Exception e) {
                                                <p>Exception occured: @e</p>
                                            }
                                        }
                                    }
                                    
                                    
                                }
                            }}
                            </div>
                        }
                        @if(Request.Cookies["studentCookie-" + Request.QueryString["lecture"]] == null) {
                            <input type="submit" value="Answer">
                        }
                        else {
                            <input type="submit" value="Answer" disabled>
                        }
                        
                            
                        </form>
                    }
                    <hr>
                    var getCourseID = db.QueryValue("SELECT T_Course.course_id FROM T_Course, T_Lecture WHERE T_Course.id = T_Lecture.course_id AND T_Lecture.id = @0", Request.QueryString["lecture"]);
                    <p><a href="?course=@getCourseID">Back to course @getCourseID</a></p>
                    <p><a href="~/">Back to front page</a></p>
                }
                else {
                    var selectedData = db.Query("SELECT course_id, course_name FROM T_Course");
                    <h1>Select a course</h1>
                    foreach(var course in selectedData) {
                        <p><a href="?course=@course.course_id">@course.course_id @course.course_name</a></p>
                    }
                    <hr>
                }
            }

            <a href="login.cshtml">Log in</a>
        </div>
    </body>
</html>
